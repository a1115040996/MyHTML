<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf8" />
		<link rel="stylesheet" type="text/css" href="css/index.css" />
	</head>

	<body>
		<!--百度地图容器-->
		<div style="width:99.9%;height:600px;border:#ccc solid 1px;" id="dituContent"></div>
	</body>
	<script src="../echarts/js/echarts.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="js/jquery-3.3.1.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" src="http://api.map.baidu.com/api?ak=UAumsTfvpKBlNPUd9e5PvAEnR0YGNllO&v=3.0&services=true"></script>
	<script type="text/javascript">
		//创建和初始化地图函数：
		function initMap() {
			createMap(); //创建地图
			setMapEvent(); //设置地图事件
			addMapControl(); //向地图添加控件
		}

		//创建地图函数：
		function createMap() {
			var map = new BMap.Map("dituContent"); //在百度地图容器中创建一个地图
			var point = new BMap.Point(116.301934, 39.977552); //定义一个中心点坐标
			map.centerAndZoom(point, 12); //设定地图的中心点和坐标并将地图显示在地图容器中
			window.map = map; //将map变量存储在全局
		}

		//地图事件设置函数：
		function setMapEvent() {
			map.enableDragging(); //启用地图拖拽事件，默认启用(可不写)
			map.enableScrollWheelZoom(); //启用地图滚轮放大缩小
			map.enableDoubleClickZoom(); //启用鼠标双击放大，默认启用(可不写)
			map.enableKeyboard(); //启用键盘上下左右键移动地图
		}

		//地图控件添加函数：
		function addMapControl() {
			//向地图中添加缩放控件
			var ctrl_nav = new BMap.NavigationControl({
			});
			map.addControl(ctrl_nav);
			//向地图中添加缩略图控件
			var ctrl_ove = new BMap.OverviewMapControl({
				anchor: BMAP_ANCHOR_BOTTOM_RIGHT,
				isOpen: 1
			});
			map.addControl(ctrl_ove);
			//向地图中添加比例尺控件
			var ctrl_sca = new BMap.ScaleControl({
				anchor: BMAP_ANCHOR_BOTTOM_LEFT
			});
			map.addControl(ctrl_sca);
		}

		initMap(); //创建和初始化地图

		function getRandomColor(hStep, idx) {
			// return echarts.color.modifyHSL('#5A94DF', Math.round(hStep * idx));
			const colorList = ['#E55125', '#5EA6FE', '#FC92F7', '#67D670', '#36FFF8', '#EEEC0D'];
			return colorList[Math.floor(Math.random() * colorList.length)];
		}
		const searchCityName = '上海';
		// 北京
		// const searchList = ["114路", "115路", "116路", "117路", "118路", "119路", "120路", "121路", "122路", "123路", "124路", "2路", "20路", "21路", "22路", "23路", "24路", "25路", "26路", "27路", "28路", "29路", "328路", "329路", "330路", "330路快车", "331路", "332路", "333路", "334路", "335路", "336路", "337路", "338路", "339路", "341路", "342路", "343路", "344路快", "345路", "345路快", "346路", "347路", "348路", "349路", "350路", "428路", "429路", "430路", "431路", "432路", "434路", "435路", "436路", "437路", "438路", "439路", "440路", "53路", "54路", "55路", "56路", "57路", "58路", "509路", "510路", "511路", "512路", "513路", "515路", "627路", "630路", "631路", "631路快", "632路", "633路", "634路", "635路", "636路", "637路", "638路", "639路", "640路", "641路", "642路", "643路", "643路区", "645路", "646路", "647路", "827路", "828路", "829路", "830路", "831路", "832路", "833路"]
		// 上海
		 const searchList = ["松江社区巴士(泾车路)", "张江环线", "张江南环线", "闵行社区巴士(浦江)", "虹桥枢纽4路", "虹桥枢纽5路", "虹桥枢纽6路", "虹桥枢纽7路", "虹桥枢纽8路", "虹桥枢纽9路", "虹桥枢纽10路", "申崇班车线", "申崇二线", "申崇六线", "申崇四线", "申崇五线", "申崇一线", "01路", "04路", "6路", "8路", "11路", "13路", "14路", "15路", "17路", "18路", "19路", "20路", "21路", "22路", "23路", "24路", "25路", "26路", "28路", "33路", "36路", "80路", "81路", "82路", "83路", "84路", "85路", "86路", "87路", "88路", "89路↵90路", "91路", "92路", "92路B线", "93路↵94路", "95路", "95路区间", "96路", "96路区间↵97路", "98路", "99路", "100路", "102大站快", "102路", "103路", "104路", "105路", "106路↵107路", "108路", "109路", "110路", "111路", "874路", "875路", "876路", "909路", "910路↵911路", "911路区间", "912路", "915路", "916路↵920路", "921路", "923路", "925路", "925路B线", "926路", "927路", "928路", "929路", "930路↵931路", "932路", "933路", "934路"];
		// 广州
		// const searchList = ["122路", "123路", "124路", "125路", "126路", "127路", "128路", "129路", "130路", "131A路环线", "131B路环线", "133路", "134路", "136路", "137路", "138路", "140路", "175路", "176路", "179路", "180路", "181路", "182路", "183路", "184路", "185路", "186路", "187路", "207路", "208路", "209路", "210路", "211路", "212路", "214路", "215路", "215路长线", "217路", "218路", "219路", "220路", "221路", "222路", "223路", "225路", "226路", "228路", "229路", "230路", "233路", "236路", "238路", "303路", "304路", "305路", "305路支线", "309A路", "309路", "310路", "311路", "312路", "320路", "321路", "322路", "323路", "324路", "325路", "326路", "327A路", "327路", "328路", "329路", "330路环线", "331路", "332路", "333a路", "333路", "334路", "335路", "336路", "411路", "412路", "413路", "414路", "415路环线", "416路环线", "417路", "420路", "421路", "422路", "423路", "424路", "425路", "426路", "427路", "428路", "429路环线", "430路", "431路", "432路环线", "433路", "434路环线", "435路", "436路环线", "437路", "438路", "439路", "440路", "530路", "534路", "535路", "538路", "539路", "540路", "541路", "542路", "543路", "544路", "545路", "546路", "547路", "548路", "550路", "551路", "552路", "555路", "556路", "560路", "562路", "563路", "564A路", "564路", "566A路", "567路", "569路", "569路支线", "87路", "88路", "89路", "801路", "803路", "804路", "805路", "805路短线", "807A路", "807路", "808路", "810A路", "810路", "811路", "812路", "813路", "823路", "825路", "826路", "827路", "828路", "830路", "831路", "832路"]
		// 重庆
		// const searchList = ["105路", "107路", "109路", "112路", "114路", "117路", "119路", "121路", "125路", "127路", "131路", "135路", "138路", "140路环线", "142路", "144路环线", "145路", "148路", "200路", "202路", "204路", "206路", "208路", "210路", "213路", "215路", "217路", "217路区间", "219路", "221路", "223路", "225路", "227路", "229路", "231路", "233路", "235路", "236路", "238路", "240路", "242路", "244路", "246路", "248路", "301路", "303路", "305路", "307路", "309路", "311路", "312路", "314路", "316路", "317路", "319路", "321路", "323路", "326路", "328路", "331路", "333路环线", "335路", "338路", "340路", "342路", "344路", "601路", "603路", "605路", "606路区间", "607路", "609路", "610路大站车", "612路", "615路", "617路", "619路", "621路", "623路", "625路", "627路", "629路", "631路", "635路", "822路", "823路夜班", "826路", "829路", "832路", "835路", "837路", "839路", "842路", "845路", "851路", "853路", "861路", "863路", "866路", "869路"]

		// 成都
		// const searchList = ["1路", "10路", "11路", "12路", "13路", "14路", "15路", "16路", "17路", "18路", "19路", "100路", "101路", "102路", "103路", "104路", "105路", "106路", "109路", "110路", "2路", "20路", "21路", "22路", "23路", "24路", "25路", "26路", "27路", "28路", "29路", "200路", "201路", "202路", "203A路环线", "203B路环线", "204路", "205路", "207路", "208路", "3路", "30路", "31路", "32A路", "32路", "33路", "34A路环线", "35路", "36路", "37路", "304路", "306路", "309路", "311路", "313路", "314路", "314a路", "315路", "316路", "319路", "5路", "50路", "52路", "53路", "54路", "55路", "56A路", "56路", "57路", "58路", "59路", "501路", "502路", "503A路", "503路", "504路", "505路", "506路", "507路", "509路"]

		// 深圳
		// const searchList = ["1路", "10路", "11路", "12路", "13路", "14路", "17路", "18路", "19路", "101路", "102路", "103路", "103路短线", "104路", "107路", "108路", "111路", "113路", "122路", "123路", "2路", "21路", "22路", "23路", "26路", "27路", "28路", "29路", "201路", "202路", "203路", "204路", "205路", "207路", "209路", "211路", "213路", "214路", "215路", "216路", "3路", "32路", "34路", "36路", "37路", "38路", "302路", "302路区间", "303路", "306路", "307路", "308路", "309路", "312路", "313路", "316路", "317路", "317路区间", "317区间高峰线路", "320路", "60路", "61路", "62路", "63路", "64路", "65路", "66路", "67路", "68路", "69路", "603路", "605路", "606路", "610路", "612路", "613路", "615路", "620路", "621路", "624路", "7路", "70路", "71路", "72路", "73路", "74路", "75路", "79路", "704路", "707路", "718路", "720路", "723路", "727路", "759路", "767路", "769路", "779路", "780路", "781路"]
		const searchListLen = searchList.length;
		let idx = 0;

		function getBusList(cityName) {

			const searchResult = [];
			var busLineSearch = new BMap.BusLineSearch(cityName, {
				renderOptions: {
					map: map,
					panel: "results"
				}, // 将查询到的地图线路信息 绘制到视图上
				onGetBusListComplete: function(result) {
					idx++;
					console.log(idx);

					console.log('百度地图地理位置', result);
					if (result && result['pA'] && result['pA'].length !== 0) {
						var fstLine = result.getBusListItem(0); //获取第一个公交列表显示到map上
						busLineSearch.getBusLine(fstLine)
					}

					// 如果没有查询出 线路数据 则跳过 查询下一条
					if (result && result['pA'] && result['pA'].length === 0 && idx < searchList.length) {
						startSearch(searchList[idx])
					}

				},
				onGetBusLineComplete: function(result) {
					console.log('bus line result ====>', result)
					if (idx < searchList.length) {
						setTimeout(() => {
							startSearch(searchList[idx]);
						}, 50)
					}
					console.log(result['company'])
					if (result['company'].indexOf(cityName) !== -1) {
						console.log(result)
						searchResult.push(formatterPosition(result['hB']));
					}
					if (idx >= searchList.length) {
						console.log('done')
						console.log(JSON.stringify(searchResult));
					}
				}
			});
			startSearch(searchList[idx]);

			function startSearch(name) {
				busLineSearch.getBusList(name);
			}
		}

		function formatterPosition(list) {
			const coords = [];
			for (let i in list) {
				coords.push([list[i]['lng'], list[i]['lat']]);
			}
			return {
				coords: coords,
				lineStyle: {
					normal: {
						color: getRandomColor(300 / (searchListLen - 1), idx)
					}
				}
			};
		}

		getBusList(searchCityName);
	</script>

</html>
